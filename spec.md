# Спецификация IPTV приложения для Windows

## 1. Описание проекта

IPTV приложение для платформы Windows, разработанное на Flutter. Приложение предназначено для воспроизведения IPTV потоков с поддержкой различных форматов плейлистов (M3U, XSPF) и управления каналами.

### 1.1 Целевая платформа
- Windows 10/11 (минимальная версия: Windows 10 1809)
- Разрешение экрана: от 1024x768 до 4K

### 1.2 Основные возможности
- Загрузка и парсинг IPTV плейлистов (M3U, M3U8)
- Просмотр списка доступных каналов
- Воспроизведение видеопотоков в реальном времени
- Управление избранными каналами
- Категоризация каналов
- Поиск по каналам
- История просмотра
- Настройки воспроизведения
- Поддержка EPG (Electronic Program Guide)
- Темная и светлая темы оформления

## 2. Функциональные требования

### 2.1 Управление плейлистами

#### 2.1.1 Загрузка плейлиста
- Импорт плейлиста из локального файла (.m3u, .m3u8)
- Импорт плейлиста по URL
- Автоматическое обновление плейлиста по расписанию
- Поддержка множественных плейлистов
- Валидация формата плейлиста перед загрузкой

#### 2.1.2 Формат плейлиста M3U
Поддержка стандартного формата M3U:
```
#EXTM3U
#EXTINF:-1 tvg-id="Channel1" tvg-name="Channel Name" tvg-logo="logo.png" group-title="Category",Channel Name
http://stream.url/channel1.m3u8
```

#### 2.1.3 Парсинг метаданных
- Извлечение информации о канале (название, логотип, группа)
- Парсинг дополнительных атрибутов (#EXTINF)
- Обработка кодировок (UTF-8, CP1251)
- Валидация URL потоков

### 2.2 Просмотр каналов

#### 2.2.1 Список каналов
- Отображение списка каналов с логотипами
- Группировка каналов по категориям
- Сетка и список режимы отображения
- Сортировка (по имени, по времени добавления, по группе)
- Пагинация для больших плейлистов

#### 2.2.2 Информация о канале
- Название канала
- Логотип канала
- Категория/группа
- Статус доступности
- URL потока

#### 2.2.3 Поиск каналов
- Поиск по названию канала
- Поиск по категории
- Фильтрация по группам
- Быстрый поиск с автодополнением

### 2.3 Воспроизведение видео

#### 2.3.1 Видеоплеер
- Воспроизведение HLS (HTTP Live Streaming)
- Воспроизведение MPEG-DASH
- Воспроизведение MP4 потоков
- Поддержка различных кодеков (H.264, H.265/HEVC, VP9)
- Аудио: AAC, MP3

#### 2.3.2 Управление воспроизведением
- Play/Pause
- Полноэкранный режим
- Регулировка громкости
- Переключение аудиодорожек (если доступно)
- Выбор качества потока (если доступно)

#### 2.3.3 Обработка ошибок
- Обработка недоступных потоков
- Автоматическое переключение на следующий канал при ошибке
- Индикация статуса загрузки
- Таймауты подключения

### 2.4 Избранное и история

#### 2.4.1 Избранное
- Добавление каналов в избранное
- Удаление из избранного
- Быстрый доступ к избранным каналам
- Экспорт списка избранного

#### 2.4.2 История просмотра
- Сохранение истории просмотра
- Очистка истории
- Быстрый доступ к последним просмотренным каналам
- Ограничение истории (например, последние 50 каналов)

### 2.5 EPG (Electronic Program Guide)

#### 2.5.1 Загрузка EPG
- Импорт EPG из XML файла
- Импорт EPG по URL
- Автоматическое обновление EPG
- Поддержка форматов XMLTV и JSON

#### 2.5.2 Отображение EPG
- Текущая программа
- Программа на день
- Расписание программ на неделю
- Фильтр по категориям программ

### 2.6 Настройки приложения

#### 2.6.1 Настройки воспроизведения
- Выбор качества по умолчанию
- Автоматическое переключение при ошибке
- Таймаут подключения
- Количество повторных попыток

#### 2.6.2 Настройки интерфейса
- Выбор темы (светлая/темная/системная)
- Размер шрифта
- Плотность отображения списка
- Показ/скрытие элементов UI

#### 2.6.3 Настройки плейлистов
- Автоматическое обновление плейлиста
- Интервал обновления
- Кэширование плейлистов

## 3. Технические требования

### 3.1 Технологический стек

#### 3.1.1 Основной фреймворк
- Flutter SDK 3.x
- Dart SDK 3.9.2+

#### 3.1.2 Зависимости (планируемые)
- `video_player` - воспроизведение видео
- `chewie` или `flutter_vlc_player` - расширенный видеоплеер
- `http` - HTTP запросы
- `path_provider` - работа с файловой системой
- `shared_preferences` - сохранение настроек
- `sqflite` или `isar` - локальная база данных
- `hive` - быстрое локальное хранилище
- `xml` - парсинг XML (EPG)
- `url_launcher` - открытие внешних ссылок
- `connectivity_plus` - проверка соединения
- `package_info_plus` - информация о приложении
- `flutter_localizations` - локализация

#### 3.1.3 Архитектура
- **Паттерн**: Clean Architecture + BLoC
- **Управление состоянием**: BLoC (flutter_bloc)
- **Dependency Injection**: manual DI или get_it
- **Роутинг**: go_router

### 3.2 Структура проекта

```
lib/
├── core/
│   ├── constants/
│   ├── errors/
│   ├── extensions/
│   ├── network/
│   ├── storage/
│   ├── theme/
│   └── utils/
├── data/
│   ├── datasources/
│   │   ├── local/
│   │   └── remote/
│   ├── models/
│   └── repositories/
├── domain/
│   ├── entities/
│   ├── repositories/
│   └── usecases/
└── presentation/
    ├── bloc/
    ├── pages/
    ├── widgets/
    └── routes/
```

### 3.3 Модели данных

#### 3.3.1 Канал (Channel)
```dart
class Channel {
  final String id;
  final String name;
  final String url;
  final String? logoUrl;
  final String? groupTitle;
  final String? tvgId;
  final Map<String, String>? attributes;
  final bool isFavorite;
  final DateTime? lastWatched;
}
```

#### 3.3.2 Плейлист (Playlist)
```dart
class Playlist {
  final String id;
  final String name;
  final String source; // URL или путь к файлу
  final DateTime lastUpdated;
  final List<Channel> channels;
  final bool isActive;
}
```

#### 3.3.3 EPG Программа (EPGProgram)
```dart
class EPGProgram {
  final String channelId;
  final String title;
  final String? description;
  final DateTime startTime;
  final DateTime endTime;
  final String? category;
  final String? iconUrl;
}
```

### 3.4 База данных

#### 3.4.1 Таблицы
- `channels` - информация о каналах
- `playlists` - информация о плейлистах
- `favorites` - избранные каналы
- `history` - история просмотра
- `epg_data` - данные EPG
- `settings` - настройки приложения

#### 3.4.2 Индексы
- Индекс по `channel_id` для быстрого поиска
- Индекс по `playlist_id` для фильтрации
- Индекс по `last_watched` для сортировки истории

### 3.5 Производительность

#### 3.5.1 Требования
- Загрузка списка из 1000+ каналов: < 2 секунд
- Переключение канала: < 1 секунда
- Парсинг плейлиста: < 500ms
- Использование памяти: < 200MB в покое

#### 3.5.2 Оптимизация
- Ленивая загрузка списка каналов
- Кэширование логотипов
- Виртуализация списков (ListView.builder)
- Изоляция парсинга в отдельном isolate

## 4. UI/UX требования

### 4.1 Дизайн интерфейса

#### 4.1.1 Общие принципы
- Material 3 дизайн
- Адаптивный интерфейс
- Поддержка клавиатурной навигации
- Горячие клавиши для основных действий

#### 4.1.2 Основные экраны
1. **Главный экран (Home)**
   - Быстрый доступ к последним каналам
   - Избранные каналы
   - История просмотра
   - Быстрый поиск

2. **Список каналов (Channels)**
   - Список/сетка каналов
   - Фильтры по категориям
   - Поисковая строка
   - Индикатор загрузки

3. **Экран просмотра (Player)**
   - Видеоплеер
   - Информация о канале
   - EPG (если доступен)
   - Кнопки управления

4. **Настройки (Settings)**
   - Группы настроек
   - Переключатели
   - Выбор параметров
   - О приложении

5. **Управление плейлистами (Playlists)**
   - Список плейлистов
   - Добавление/удаление
   - Редактирование
   - Статистика

### 4.2 Темизация

#### 4.2.1 Светлая тема
- Основной цвет: синий (#1976D2)
- Фон: белый (#FFFFFF)
- Текст: темно-серый (#212121)
- Акцент: синий (#1976D2)

#### 4.2.2 Темная тема
- Основной цвет: синий (#42A5F5)
- Фон: темно-серый (#121212)
- Текст: светло-серый (#E0E0E0)
- Акцент: синий (#42A5F5)

### 4.3 Анимации
- Плавные переходы между экранами
- Анимация загрузки
- Плавное появление элементов списка
- Переходы при переключении каналов

### 4.4 Горячие клавиши
- `Space` - Play/Pause
- `F` - Полноэкранный режим
- `←/→` - Переключение каналов
- `↑/↓` - Регулировка громкости
- `Ctrl+F` - Поиск
- `Ctrl+,` - Настройки
- `Esc` - Выход из полноэкранного режима

## 5. Особенности Windows

### 5.1 Интеграция с Windows

#### 5.1.1 Особенности
- Нативный вид окна
- Поддержка Windows 10/11 дизайна
- Интеграция с системным медиа-контроллером
- Поддержка Windows Media Controls API

#### 5.1.2 Файловая система
- Доступ к локальным файлам
- Диалог выбора файла
- Сохранение данных в AppData
- Работа с сетевые папками

#### 5.1.3 Окно приложения
- Минимальный размер: 1024x768
- Запоминание размера и положения окна
- Поддержка полноэкранного режима
- Всегда поверх (опционально)

### 5.2 Производительность Windows

#### 5.2.1 Оптимизация
- Использование аппаратного ускорения видео
- Оптимизация для Windows DirectX
- Эффективное использование памяти
- Фоновое обновление плейлистов

#### 5.2.2 Совместимость
- Поддержка Windows 10 (1809+)
- Поддержка Windows 11
- x64 архитектура
- x86 архитектура (опционально)

## 6. Безопасность и приватность

### 6.1 Безопасность данных
- Локальное хранение плейлистов
- Шифрование чувствительных данных (если требуется)
- Валидация URL перед подключением
- Защита от XSS в EPG данных

### 6.2 Приватность
- Не отправка данных на внешние серверы
- Локальное хранение истории
- Возможность очистки всех данных
- Прозрачная политика конфиденциальности

## 7. Тестирование

### 7.1 Типы тестов
- Unit тесты для бизнес-логики
- Widget тесты для UI компонентов
- Integration тесты для основных сценариев
- Тесты производительности

### 7.2 Покрытие тестами
- Минимальное покрытие: 70%
- Критическая логика: 90%+

## 8. Локализация

### 8.1 Поддерживаемые языки
- Русский (основной)
- Английский
- Возможность добавления других языков

### 8.2 Локализуемые элементы
- Интерфейс приложения
- Сообщения об ошибках
- Помощь и документация

## 9. Планы разработки

### 9.1 Этап 1: MVP (Минимально жизнеспособный продукт)
- [ ] Базовая структура проекта
- [ ] Парсинг M3U плейлистов
- [ ] Список каналов
- [ ] Базовый видеоплеер
- [ ] Главный экран
- [ ] Простые настройки

### 9.2 Этап 2: Базовый функционал
- [ ] Избранное
- [ ] История просмотра
- [ ] Поиск по каналам
- [ ] Группировка по категориям
- [ ] Улучшенный видеоплеер
- [ ] Темы оформления

### 9.3 Этап 3: Расширенный функционал
- [ ] Поддержка EPG
- [ ] Множественные плейлисты
- [ ] Автоматическое обновление плейлистов
- [ ] Экспорт/импорт настроек
- [ ] Горячие клавиши
- [ ] Windows интеграция

### 9.4 Этап 4: Оптимизация и полировка
- [ ] Оптимизация производительности
- [ ] Улучшение UI/UX
- [ ] Расширенное тестирование
- [ ] Документация
- [ ] Локализация

## 10. Известные ограничения

### 10.1 Технические ограничения
- Зависимость от качества интернет-соединения
- Поддержка только потоковых протоколов (HTTP/HTTPS)
- Нет поддержки DRM защищенных потоков

### 10.2 Функциональные ограничения
- Нет поддержки записи трансляций (в начальной версии)
- Нет поддержки пиктограмм на каналах без URL
- Ограниченная поддержка EPG (зависит от источника)

## 11. Будущие улучшения

### 11.1 Планируемые функции
- Запись трансляций
- Поддержка субтитров
- Планировщик просмотра
- Социальные функции (поделиться каналом)
- Плагины и расширения
- Поддержка кастомных скриптов парсинга

### 11.2 Оптимизации
- Поддержка GPU ускорения
- Улучшенное кэширование
- Адаптивное качество потока
- Предзагрузка следующего канала

## 12. Справочная информация

### 12.1 Форматы плейлистов
- M3U - стандартный формат плейлистов
- M3U8 - UTF-8 версия M3U
- XSPF - XML формат (опционально)

### 12.2 Протоколы потоков
- HLS (HTTP Live Streaming) - основной протокол
- MPEG-DASH - альтернативный протокол
- HTTP progressive download - для MP4 файлов

### 12.3 Полезные ссылки
- [M3U формат спецификация](https://en.wikipedia.org/wiki/M3U)
- [HLS спецификация](https://tools.ietf.org/html/rfc8216)
- [XMLTV формат](https://github.com/XMLTV/xmltv)

---

**Версия документа**: 1.0  
**Дата создания**: 2024  
**Статус**: Черновик

